# CH03 영속성 관리

### 엔티티 매니저 팩토리와 엔티티 매니저

- 전에도 설명이 나왔지만, 엔티티 매니저 팩토리를 생성하는 비용은 비싸기 때문에 일반적으로 1개만 생성해서 여러 스레드가 공유해서 사용한다. 하지만 엔티티 매니저의 경우 여러 스레드에서 접근시 동시성 문제가 발생하기 때문에 공유하면 안된다.
- 엔티티 매니저는 db connection이 꼭 필요한 시점에 커넥션을 얻는다. 그 전까지는 얻지 않는다.
    - 예를 들어, 트랜잭션을 시작할 때 커넥션을 획득한다.
    

### 영속성 컨텍스트란?

- 엔티티 매니저를 통해 엔티티를 관리하는 환경
- 영속은 엔티티가 관리됨을 의미

### 엔티티의 생명주기

- 비영속(new/transient) : 영속성 컨텍스트와 전혀 관계 없는 환경
- 영속(managed) : 영속성 컨텍스트에 저장된 상태
- 준영속(detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제(removed) : 삭제된 상태

### 영속성 컨텍스트의 특징

- 영속성 컨텍스트는 식별자를 이용해 엔티티를 구분함 - 고로 영속 상태는 식별자 값이 반드시 필요
- 트랜잭션을 커밋하는 순간 영속성 컨텍스트를 데이터베이스로 반영하는데 이걸 플러시라고 함
- 영속성 컨텍스트로 엔티티를 관리하는 장점
    - 1차 캐시 - 미미함
        - find() : 1차 캐시에서 조회 → 없으면 DB에서 꺼내오고 → 이걸 1차 캐시에 저장 → 반환
        - 엔티티 매니저는 트랜잭션 단위로 생성, 삭제되므로 1차 캐시 성능 향상 이점은 미미함
    - 동일성 보장
        - 식별자가 같은 엔티티 인스턴스를 find()로 조회하면 ==의 결과 값이 true → 엔티티 동일성 보장
        - 어려운 말로 1차 캐시를 통해 REPEATABLE READ(반복 읽기 가능) 등급의 트랜잭션 격리 수준을 데이터베이스가 아닌 애플리케이션 차원에서 제공함
    - 트랜잭션을 지원하는 쓰기 지연(transactional write-behind)
        - 트랜잭션 커밋 시점에 모아둔 쿼리를 DB에 한 번에 보냄
    - 변경 감지(dirty checking)
        - JPA는 엔티티를 영속성 컨텍스트에 보관할 때, 최초 상태를 복사해 저장해 두는 데 이걸 스냅샷이라 함
        - 플러시 시점에 스냅샷과 최초 스냅샷을 비교해 변경된 엔티티를 찾아 update 쿼리를 생성해 query 저장소로 보냄(커밋 시점에 DB로 보내짐)
        - 영속 상태의 엔티티에만 적용됨
        - JPA의 기본 전략은 엔티티의 모든 필드를 업데이트함
            - 데이터 전송량 증가의 단점이 있으나 아래와 같은 장점으로 모든 필드를 업데이트함
                - 애플리케이션 로딩 시점에 수정 쿼리를 미리 생성해두고 재사용할 수 있음
                - 데이터베이스는 이전에 한 번 파싱된 쿼리를 재사용할 수 있음
            - 필드가 많거나 수정된 데이터만 사용해 동적으로 UPDATE SQL을 생성하는 전략을 선택하면 됨 → `@org.hibernate.annotations.DynamicUpdate` 어노테이션 확장 기능 사용
            - → `@DynamicInsert` 도 사용 가능
            - 수정되는 컬럼 수가 대략 30개가 넘으면 동적 수정 쿼리가 빠르다고 한다. 단, 한 테이블에 컬럼이 30개 이상이라면 설계상 책임이 적절히 분리되지 않았을 수 있다.
    - 지연 로딩

### 플러시

- 영속성 컨텍스트의 변경 내용을 DB에 동기화하는 작업
- 플러시는 영속성 컨텍스트의 내용을 지우는게 아님을 주의!!

플러시 하는 방법

1. em.flush() 직접 호출
2. 트랜잭션 커밋 시 플러시 자동 호출
3. JPQL 쿼리 실행 시 플러시 자동 호출됨

### 준영속

- 영속성 컨텍스트에서 분리된 상태로 영속성 컨텍스트의 기능을 당연히 사용할 수 없음
- 비영속 상태에 가까우나 식별자 값은 갖고 있고, 지연로딩을 사용할 수 없다.
- em.detach(entity) : 특정 엔티티만 준영속 상태로 전환
- em.clear() : 영속성 컨텍스트를 완전히 초기화
- em.close() : 영속성 컨텍스트를 종료
- em.merge(entity) : 다시 영속상태로 변경, 새로운 영속 상태의 엔티티 반환